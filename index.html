<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <title>Student Placement Lookup</title>
  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Optional: Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <style>
    body { background: #f7f8fa; }
    .page { display: none; }
    .page.active { display: block; }
    .card { box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .brand { font-weight: 700; letter-spacing: 0.3px; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-6">

        <div class="text-center mb-4">
          <div class="brand h4 mb-2">Student Placement Lookup</div>
          <div class="text-muted">Find your class details in seconds</div>
        </div>

        <!-- Alerts -->
        <div id="alertBox" class="alert d-none" role="alert" aria-live="assertive"></div>

        <!-- Page 1: Search -->
        <div id="page-search" class="page active">
          <div class="card">
            <div class="card-body">
              <form id="searchForm" novalidate>
                <div class="mb-3">
                  <label for="studentInput" class="form-label">
                    Please enter the last 5 digits of your student number
                  </label>
                  <input
                    id="studentInput"
                    name="studentInput"
                    class="form-control"
                    placeholder="e.g., 12345"
                    inputmode="numeric"
                    autocomplete="off"
                    pattern="\\d{5,}"
                    aria-describedby="helpBlock"
                    required
                  />
                  <div id="helpBlock" class="form-text">
                    You can paste the full number; weâ€™ll use the last 5 digits.
                  </div>
                </div>

                <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
                  <button id="searchBtn" type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search
                  </button>
                </div>

                <div class="mt-3 small text-muted" id="loadingStatus">
                  Loading student list...
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Page 2: Result -->
        <div id="page-result" class="page">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-3">Your class details</h5>
              <pre id="resultPre" class="mb-4" style="white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></pre>
              <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
                <button id="backBtn" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left"></i> Search again
                </button>
              </div>
            </div>
          </div>
          <div class="text-center mt-3 small text-muted">
            If anything looks off, please contact a student advisor.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- PapaParse for robust CSV parsing (handles quotes and newlines) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    (function () {
      const alertBox = document.getElementById('alertBox');
      const pageSearch = document.getElementById('page-search');
      const pageResult = document.getElementById('page-result');
      const searchForm = document.getElementById('searchForm');
      const studentInput = document.getElementById('studentInput');
      const searchBtn = document.getElementById('searchBtn');
      const resultPre = document.getElementById('resultPre');
      const backBtn = document.getElementById('backBtn');
      const loadingStatus = document.getElementById('loadingStatus');

      let ready = false;
      let indexByLast5 = {}; // { "12345": row }

      // Helpers
      function showAlert(message, type = 'danger') {
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.classList.remove('d-none');
      }
      function clearAlert() {
        alertBox.className = 'alert d-none';
        alertBox.textContent = '';
      }
      function showPage(id) {
        [pageSearch, pageResult].forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }
      function sanitizeDigits(value) {
        return (value || '').replace(/\D/g, '');
      }
      function last5(value) {
        const digits = sanitizeDigits(value);
        return digits.slice(-5); // supports longer inputs
      }
      function resetInput() {
        studentInput.value = '';
        studentInput.focus();
      }

      // Load and index the CSV
      function loadCSV() {
        fetch('202509.csv', { cache: 'no-store' })
          .then(resp => {
            if (!resp.ok) throw new Error('Failed to load CSV');
            return resp.text();
          })
          .then(csvText => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: false,
              complete: (results) => {
                // Build index keyed by last 5 of ST#
                (results.data || []).forEach(row => {
                  const st = (row['ST#'] || '').toString().trim();
                  if (!st) return;
                  const key = last5(st);
                  if (key) indexByLast5[key] = row;
                });
                ready = true;
                loadingStatus.textContent = 'Loaded. You can search now.';
                searchBtn.disabled = false;
              },
              error: (err) => {
                console.error(err);
                loadingStatus.textContent = 'Error loading data. Please try refreshing the page.';
                searchBtn.disabled = true;
                showAlert('There was a problem loading the student list. Please refresh and try again.');
              }
            });
          })
          .catch(err => {
            console.error(err);
            loadingStatus.textContent = 'Error loading data. Please try refreshing the page.';
            searchBtn.disabled = true;
            showAlert('There was a problem loading the student list. Please refresh and try again.');
          });
      }

      // Initialize
      searchBtn.disabled = true;
      loadCSV();

      // Form submit handler
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        clearAlert();

        if (!ready) {
          showAlert('Data is still loading. Please wait a moment.');
          return;
        }

        const inputVal = studentInput.value.trim();
        const key = last5(inputVal);

        if (!key || key.length < 5) {
          showAlert('Please enter at least 5 digits.');
          return;
        }

        const hit = indexByLast5[key];
        if (!hit) {
          showAlert('your student number is incorrect or you are not yet placed in class. Please see a student advisor');
          resetInput();
          return;
        }

        // Build result view
        const lines = [];
        // Ensure we only show the requested fields
        lines.push(`Student Number: ${key}`);
        lines.push(`Full Name: ${hit['Name'] || ''}`);
        lines.push(`Program: ${hit['Program'] || ''}`);
        lines.push(`Course: ${hit['Course'] || ''}`);
        lines.push(`Campus: ${hit['Campus'] || ''}`);
        lines.push(`Room: ${hit['Room'] || ''}`);

        resultPre.textContent = lines.join('\n');
        showPage('page-result');
        resetInput();
        clearAlert();
      });

      // Back to search
      backBtn.addEventListener('click', () => {
        showPage('page-search');
        clearAlert();
      });
    })();
  </script>
</body>
</html>
